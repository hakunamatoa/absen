<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Absensi (nama toko)</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet" />
  <style>
    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      padding: 0;
      font-family: 'Inter', sans-serif;
      background: #f9fbfc;
      color: #333;
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100vh;
      flex-direction: column;
      text-align: center;
    }

    .container {
      background: #ffffff;
      padding: 2rem;
      border-radius: 16px;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.05);
      max-width: 400px;
      width: 90%;
    }

    h3 {
      font-size: 20px;
      margin-bottom: 1rem;
      color: #2c3e50;
    }

    #loading {
      display: none;
      margin: 1rem auto;
    }

    .spinner {
      border: 4px solid #e0e0e0;
      border-top: 4px solid #3498db;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto;
    }

    @keyframes spin {
      0% {
        transform: rotate(0deg);
      }

      100% {
        transform: rotate(360deg);
      }
    }

    #error-message {
      margin-top: 1rem;
      color: #e74c3c;
      font-size: 16px;
    }

    .status-success {
      color: #27ae60;
    }

    .status-warning {
      color: #f39c12;
    }

    .status-error {
      color: #e74c3c;
    }

    footer {
      font-size: 12px;
      margin-top: 20px;
      color: #aaa;
    }
  </style>
</head>
<body>
  <div class="container">
    <h3 id="status">üìç Mengambil lokasi dan mengirim absen...</h3>
    <div id="loading" class="spinner"></div>
    <div id="error-message"></div>
    <footer>&copy; 2025 Sistem Absensi</footer>
  </div>

  <script>
    // Fungsi untuk set status dan simpan ke localStorage
    function setStatus(status, message) {
      const statusEl = document.getElementById("status");
      const errorMessageEl = document.getElementById("error-message");
      const loadingEl = document.getElementById("loading");

      loadingEl.style.display = "none";
      errorMessageEl.textContent = "";

      if (status === "OK") {
        statusEl.textContent = `‚úÖ ${message}`;
        statusEl.className = "status-success";
      } else if (status === "DUPLICATE") {
        statusEl.textContent = `‚ö†Ô∏è ${message}`;
        statusEl.className = "status-warning";
      } else if (status === "ERROR") {
        statusEl.textContent = `‚ùå ${message}`;
        statusEl.className = "status-error";
        errorMessageEl.textContent = message;
      } else {
        statusEl.textContent = message;
        statusEl.className = "";
      }

      // Simpan ke localStorage
      localStorage.setItem("absenStatus", JSON.stringify({ status, message }));
    }

    // Fungsi untuk load status dari localStorage
    function loadStatus() {
      const saved = localStorage.getItem("absenStatus");
      if (saved) {
        try {
          const obj = JSON.parse(saved);
          setStatus(obj.status, obj.message);
          return true;
        } catch {
          return false;
        }
      }
      return false;
    }

    window.onload = function () {
      const params = new URLSearchParams(window.location.search);
      const nama = params.get("nama") || "N/A";
      const barcode = params.get("barcode") || "N/A";
      const token = params.get("token") || "";

      const statusEl = document.getElementById("status");
      const loadingEl = document.getElementById("loading");
      const errorMessageEl = document.getElementById("error-message");

      // Coba tampilkan status sebelumnya (jika ada)
      if (loadStatus()) {
        // Jika sudah ada status tersimpan, jangan kirim ulang
        return;
      }

      if (!navigator.geolocation) {
        setStatus("ERROR", "Browser tidak mendukung lokasi. Gunakan browser yang mendukung geolocation seperti Chrome.");
        return;
      }

      statusEl.textContent = "üìç Mengambil lokasi...";
      loadingEl.style.display = "block";

      navigator.geolocation.getCurrentPosition(
        (pos) => {
          const lokasi = `${pos.coords.latitude},${pos.coords.longitude}`;
          let url =
            "https://script.google.com/macros/s/AKfycbwRaiGz_qREOuwsc8LzQtiKP7ANRrXDnI0i41Dblaef7TvTvCAOICtxeyCUemzmzds5/exec" +
            "?nama=" +
            encodeURIComponent(nama) +
            "&barcode=" +
            encodeURIComponent(barcode) +
            "&lokasi=" +
            encodeURIComponent(lokasi);

          if (token) {
            url += "&token=" + encodeURIComponent(token);
          }

          statusEl.textContent = "‚è≥ Mengirim data absen...";

          fetch(url)
            .then((res) => {
              const contentType = res.headers.get("content-type") || "";
              if (!contentType.includes("application/json")) {
                throw new Error("Respon bukan JSON");
              }
              return res.json();
            })
            .then((resp) => {
              setStatus(resp.status, resp.message);
            })
            .catch((err) => {
              console.error("Fetch error:", err);
              setStatus("ERROR", "Gagal mengirim absen. Silakan coba lagi.");
            });
        },
        (err) => {
          setStatus("ERROR", `Gagal ambil lokasi: ${err.message}`);
        }
      );
    };
  </script>
</body>
</html>
